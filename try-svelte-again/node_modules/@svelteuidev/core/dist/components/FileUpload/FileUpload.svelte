<script context="module">export const ctx = 'Upload';
</script>

<script>import useStyles, { fontSizes } from './FileUpload.styles';
import { Box } from '../Box';
import { createEventForwarder, useActions } from '../../internal';
import { createEventDispatcher, get_current_component } from 'svelte/internal';
import { randomID } from '../../styles';
import IconRenderer from '../IconRenderer/IconRenderer.svelte';
import Button from '../Button/Button.svelte';
export let use = [], element = undefined, className = '', override = {}, accept = undefined, type = undefined, name = undefined, multiple = false, files = [], label = 'Upload', color = 'blue', size = 'sm', disabled = false, id = randomID(), icon = undefined, fileIcon = undefined, removeIcon = undefined, reset = true, resetLabel = 'Reset', resetColor = 'red', resetIcon = undefined, preview = true;
export { className as class };
let fileUploadComponent = undefined;
const dispatch = createEventDispatcher();
/** An action that forwards inner dom node events from parent component */
const forwardEvents = createEventForwarder(get_current_component(), [
    'selected',
    'removed',
    'reset'
]);
function onFileSelected(e) {
    let localFile = [];
    for (let i = 0; i < e.files.length; i++) {
        let file = e.files[i];
        localFile.push({
            name: file.name,
            icon: file.name,
            size: file.size,
            file: file
        });
    }
    if (multiple) {
        files = [...files, ...localFile];
    }
    else {
        files = [...localFile];
    }
    dispatch('selected', files);
}
function remove(index) {
    fileUploadComponent.value = '';
    dispatch('removed', { file: files[index], index });
    files = files.filter((e, i) => i !== index);
}
function resetFiles() {
    fileUploadComponent.value = '';
    files = [];
    dispatch('reset');
}
$: ({ cx, classes, getStyles } = useStyles({ color, size }, { name: 'FileUpload' }));
</script>

<Box bind:element {use} class={cx(className, classes.root)} {...$$restProps}>
	<div class={classes.inputContainer}>
		<input
			bind:this={fileUploadComponent}
			type="file"
			{multiple}
			{accept}
			{id}
			{disabled}
			tabindex="-1"
			{name}
			on:change={({ target }) => {
				onFileSelected(target);
			}}
			use:useActions={use}
			use:forwardEvents
		/>
	</div>

	{#if type && type == 'drag'}
		<label
			on:dragleave
			on:dragover={(ev) => {
				ev.preventDefault();
			}}
			on:drop|preventDefault|stopPropagation={({ dataTransfer }) => {
				onFileSelected(dataTransfer);
			}}
			for={id}
			class={cx(classes.drag, getStyles({ css: override }))}
			class:disabled
		>
			<slot />
		</label>
	{:else}
		<div class={classes.buttonType}>
			<Button
				{size}
				{disabled}
				{color}
				on:click={() => {
					fileUploadComponent.click();
				}}
			>
				<IconRenderer slot="leftIcon" {icon} />

				{label}
			</Button>
			{#if reset}
				<Button {size} color={resetColor} disabled={files.length == 0} on:click={resetFiles}>
					<IconRenderer slot="leftIcon" icon={resetIcon} />
					{resetLabel}
				</Button>
			{/if}
		</div>
	{/if}
</Box>
{#if preview}
	{#each files as { file }, i}
		<div class={classes.fileItemWrapper}>
			<div class={classes.fileItemIcon}>
				<IconRenderer iconSize={fontSizes[size] * 1.8} icon={fileIcon} />
			</div>
			<span class={classes.fileItemName}>
				{file.name}
			</span>
			<span class={classes.fileItemAction}>
				<span>
					<Button variant="default" {size} on:click={() => remove(i)}>
						<IconRenderer iconSize={fontSizes[size] * 1.5} icon={removeIcon} />
					</Button>
				</span>
			</span>
		</div>
	{/each}
{/if}
