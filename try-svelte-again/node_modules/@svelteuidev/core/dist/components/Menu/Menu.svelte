<script context="module">export const ctx = 'Menu';
</script>

<script>import useStyles, { getNextItem, getPreviousItem } from './Menu.styles';
import { createEventDispatcher, onMount, setContext } from 'svelte';
import { writable } from 'svelte/store';
import { Box } from '../Box';
import { Popper } from '../Popper';
import { Paper } from '../Paper';
import { MenuIcon } from './index';
import { clickoutside, useHash } from '@svelteuidev/composables';
import { createEventForwarder, useActions } from '../../internal';
import { get_current_component } from 'svelte/internal';
export let use = [], element = undefined, className = '', override = {}, closeOnItemClick = true, closeOnScroll = false, delay = 100, menuButtonLabel = undefined, menuId = undefined, radius = 'sm', opened = false, shadow = 'md', size = 'md', trigger = 'click', trapFocus = true, withinPortal = true, zIndex = 300, withArrow = false, gutter = 5, placement = 'start', position = 'bottom', transition = 'fade', transitionOptions = { duration: 100 };
export { className as class };
const dispatch = createEventDispatcher();
/** Function that allows changing the state of the menu from outside the component */
export function open() {
    external = true;
    handleOpen();
    onExternal();
}
export function close() {
    external = true;
    handleClose();
    onExternal();
}
export function toggle() {
    external = true;
    toggleMenu();
    onExternal();
}
// Ugly hack for click outside workaround, since an external
// triggered click causes the action to take effect
// @TODO: improve this in the future
function onExternal() {
    window.setTimeout(() => (external = false), 0);
}
let external = false;
let delayTimeout;
let referenceElement;
let dropdownElement;
let control;
let hovered = -1;
const clickOutsideParams = {
    enabled: true,
    callback: () => _opened && !external && handleClose()
};
const uuid = useHash(menuId);
const forwardEvents = createEventForwarder(get_current_component(), ['open', 'close']);
const castKeyboardEvent = (event) => event;
// can be turned into an action
const focusReference = () => window.setTimeout(() => referenceElement?.focus(), 0);
onMount(() => {
    if (!$$slots.control)
        return;
    control = element.children[0];
    control.setAttribute('role', 'button');
    control.setAttribute('aria-haspopup', 'menu');
    control.setAttribute('aria-expanded', String(_opened));
    control.setAttribute('aria-controls', uuid);
    if (menuButtonLabel)
        control.setAttribute('aria-label', menuButtonLabel);
    control.addEventListener('click', (event) => {
        event.stopPropagation();
        toggleMenu();
    });
    control.addEventListener('mouseenter', () => (trigger === 'hover' ? handleOpen() : null));
    control.addEventListener('keydown', (event) => handleKeyDown(castKeyboardEvent(event)));
});
const handleClose = () => {
    if (_opened) {
        _opened = false;
        opened = false;
        dispatch('close');
    }
};
const handleOpen = () => {
    _opened = true;
    opened = true;
    dispatch('open');
};
const toggleMenu = () => {
    _opened ? handleClose() : handleOpen();
};
const handleMouseLeave = () => {
    if (trigger === 'hover') {
        if (delay > 0) {
            delayTimeout = window.setTimeout(() => handleClose(), delay);
        }
        else {
            handleClose();
        }
    }
};
const handleMouseEnter = () => {
    window.clearTimeout(delayTimeout);
};
const handleKeyDown = (event) => {
    if (_opened) {
        const elements = Array.from(dropdownElement.querySelectorAll('.svelteui-MenuItem-root'));
        if (event.code === 'Tab' && trapFocus) {
            event.preventDefault();
        }
        if (event.code === 'ArrowDown') {
            event.preventDefault();
            const prevIndex = getNextItem(hovered, elements);
            hovered = prevIndex;
            elements[prevIndex].focus();
        }
        if (event.code === 'ArrowUp') {
            event.preventDefault();
            const prevIndex = getPreviousItem(hovered, elements);
            hovered = prevIndex;
            elements[prevIndex].focus();
        }
        if (event.code === 'Escape') {
            handleClose();
            focusReference();
        }
    }
};
const handleItemClick = () => {
    if (closeOnItemClick) {
        handleClose();
        trigger === 'click' && focusReference();
    }
};
const contextStore = writable({
    hovered,
    radius,
    onItemHover: (hover) => (hovered = hover),
    onItemKeyDown: handleKeyDown,
    onItemClick: handleItemClick
});
$: _opened = opened;
$: if ($$slots.control && control)
    control.setAttribute('aria-expanded', String(_opened));
$: contextStore.set({
    hovered,
    radius,
    onItemHover: (hover) => (hovered = hover),
    onItemKeyDown: handleKeyDown,
    onItemClick: handleItemClick
});
$: ({ cx, classes } = useStyles({ size }, { override, name: 'Menu' }));
setContext(ctx, contextStore);
</script>

<svelte:window on:scroll={() => closeOnScroll && handleClose()} />

<Box
	bind:element
	use={[forwardEvents, [useActions, use], [clickoutside, clickOutsideParams]]}
	class={cx(classes.root, className)}
	on:mouseleave={handleMouseLeave}
	on:mouseenter={handleMouseEnter}
	{...$$restProps}
>
	<slot name="control">
		<MenuIcon
			bind:element={referenceElement}
			role="button"
			aria-haspopup="menu"
			aria-expanded={_opened}
			aria-controls={uuid}
			aria-label={menuButtonLabel}
			title={menuButtonLabel}
			on:click!stopPropagation={toggleMenu}
			on:keydown={(event) => handleKeyDown(castKeyboardEvent(event))}
			on:mouseenter={() => (trigger === 'hover' ? handleOpen() : null)}
		/>
	</slot>
	<Popper
		reference={control ?? referenceElement}
		mounted={_opened}
		arrowSize={3}
		arrowClassName={classes.arrow}
		{transition}
		{transitionOptions}
		{position}
		{placement}
		{gutter}
		{withArrow}
		{zIndex}
		{withinPortal}
	>
		<Paper
			bind:element={dropdownElement}
			use={[[clickoutside, clickOutsideParams]]}
			id={uuid}
			role="menu"
			class={cx(classes.body)}
			aria-orientation="vertical"
			{radius}
			on:mouseleave={() => (hovered = -1)}
			{shadow}
		>
			<slot />
		</Paper>
	</Popper>
</Box>
